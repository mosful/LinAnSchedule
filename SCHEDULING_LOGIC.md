# 教會排班系統邏輯說明

## 1. 核心概念

### 1.1 排班類型
- **聯合 (Joint)**：只有第一堂，第二堂為空
- **分堂 (Non-Joint)**：有第一堂和第二堂兩個禮拜

### 1.2 服事角色
- **投影手** (`投影手`)：負責投影機操作
- **音控手** (`音控手`)：負責音響控制
- **第一堂工作人員** (`第一堂工作人員`)：只能在第一堂服事
- **第二堂工作人員** (`第二堂工作人員`)：只能在第二堂服事

### 1.3 人員狀態管理
- **失效** (`isInactive`)：人員因長期請假、出國出差等原因暫時無法服事
  - 失效的人員**不會出現**在自動排班中
  - 失效的人員**不會出現**在下拉選單中
  - 可隨時恢復正常狀態

### 1.4 輪流分配機制 + 條件式綁定 (v3.0)
- **核心原則 1 - 公平輪流**：預設採用輪流分配，優先分配給最久沒被分配的人。
- **核心原則 2 - 條件式綁定**：若投影手輪到 **郭嘉玲**，則音控手 **必須** 是 **陳俊亨**。
- **核心原則 3 - 防止過勞**：避免同一人連續三週服事（檢查前兩週）。

---

## 2. 自動排班邏輯 (`autoAssign`) - 循序處理

系統會按日期順序逐一處理排班，確保每一週的分配都參考了前一週的結果。

### 2.1 聯合排班 (`isJoint = true`)

**步驟 1：選擇投影手**
- 從所有可用投影手中，選出「最久沒服事」的一位。
- 檢查是否連續服事（若前兩週都有服事則跳過）。

**步驟 2：選擇音控手**
- **情況 A：投影手是 郭嘉玲**
  - 強制檢查 **陳俊亨** 是否可用。
  - 若陳可用 → 音控手指定為陳俊亨。
  - 若陳不可用/過勞 → 郭嘉玲也不能服事，放棄郭嘉玲，重新選擇下一位投影手。
- **情況 B：投影手非 郭嘉玲**
  - 從所有可用音控手中（排除已選投影手），選出「最久沒服事」的一位。
  - 檢查是否連續服事。

### 2.2 分堂排班 (`isJoint = false`)

**步驟 1：處理第一堂 (Service 1)**
- 逻辑同聯合排班：
  - 選擇最久沒服事的投影手（需排除「第二堂專用」）。
  - 若投影是郭嘉玲 → 強制搭配音控陳俊亨。
  - 若非郭嘉玲 → 選擇最久沒服事的音控手（需排除「第二堂專用」）。

**步驟 2：處理第二堂 (Service 2)**
- **排除名單**：加入第一堂已選的兩人。
- **選擇投影手**：從輪流池選出最久沒服事者（需排除「第一堂專用」）。
- **選擇音控手**：從輪流池選出最久沒服事者（需排除「第一堂專用」及剛選出的 Service 2 投影手）。

---

## 3. 人員篩選邏輯 (`getCandidatesSequentially`)

### 3.1 篩選條件
必須滿足所有條件：
1. ✅ **不是失效狀態** (`isInactive === false`)
2. ✅ 具有指定角色（例如：`投影手` 或 `音控手`）
3. ✅ 未被列入該日期的「不可服事日期」
4. ✅ 不在排除名單 (`excludeIds`) 中
5. ✅ **Service 限制**：
   - Service 1 排除 `第二堂工作人員`
   - Service 2 排除 `第一堂工作人員`

### 3.2 選擇方式
- **排序**：按「最後服事日期」排序（日期越早越優先）。
- **連續服事檢查**：若該員在本次排班日期的前 2 筆排班中都出現過，則視為過勞，跳過不選。

---

## 4. 特殊規則矩陣

| 規則 | 邏輯 | 說明 |
|------|------|------|
| **郭嘉玲綁定** | 若投影=郭嘉玲 → 音控=陳俊亨 | 單向綁定。若陳不可用，則郭也不能上場。 |
| **陳俊亨獨立** | 若輪流輪到陳俊亨（作為音控） | 不受限制，可搭配任何人（除非遇到郭當投影）。 |
| **連續服事** | 檢查前 2 週 | 避免連續 3 週服事。 |
| **循序排班** | 按日期排序執行 | 確保 12/25 的排班會考慮 12/18 的結果。 |

---

## 5. 常見情況模擬

### 情況 A：輪到郭嘉玲，但陳俊亨請假
- 系統嘗試選擇郭嘉玲。
- 檢查發現陳俊亨請假（或過勞）。
- **結果**：系統跳過郭嘉玲，改選下一順位的投影手。

### 情況 B：連續兩週服事 (12/01, 12/08)
- 輪到 12/15 排班時。
- 系統檢查發現該員在 12/01 和 12/08 都有服事。
- **結果**：跳過該員，即使他是「最久沒服事」的第一順位。

### 情況 C：新的一年開始
- 由於採用相對日期的輪流機制。
- 新增排班時，會自動接續去年的服事記錄繼續輪流，不會重置。

---

## 6. 技術實現細節更新 (v3.0)

### 6.1 循序處理 (Sequential Processing)
為了讓「最久沒服事」和「連續服事檢查」在一次生成多週排班時能正確運作，程式不再使用 `map` 並行處理，而是使用 `assignments` 的工作副本 (`workingSchedules`) 進行 `for` 迴圈循序處理。

### 6.2 動態歷史查詢
- `getLastAssignmentBefore(personId, date)`：即時查詢工作副本中，指定日期之前的最後一次服事。
- `hasServedConsecutively(personId, date, n)`：查詢工作副本中，指定日期前 N 筆記錄是否都有該員。

---

**最後更新**：2025-12-13 (v3.0 - 條件式綁定與循序排班)
**版本**：3.0 
- v1.0：強制配對優先
- v2.0：純輪流
- v3.0：**輪流優先 + 條件綁定 (郭→陳)** + 連續服事限制
