# 教會排班系統邏輯說明

## 1. 核心概念

### 1.1 排班類型
- **聯合 (Joint)**：只有第一堂，第二堂為空
- **分堂 (Non-Joint)**：有第一堂和第二堂兩個禮拜

### 1.2 服事角色
- **投影手** (`投影手`)：負責投影機操作
- **音控手** (`音控手`)：負責音響控制
- **第一堂工作人員** (`第一堂工作人員`)：只能在第一堂服事
- **第二堂工作人員** (`第二堂工作人員`)：只能在第二堂服事

### 1.3 人員狀態管理
- **失效** (`isInactive`)：人員因長期請假、出國出差等原因暫時無法服事
  - 失效的人員**不會出現**在自動排班中
  - 失效的人員**不會出現**在下拉選單中
  - 可隨時恢復正常狀態

### 1.3 輪流分配機制 + 強制配對 ✨ (混合版本)
- **核心原則 1**：陳俊亨和郭嘉玲必須優先配對分配
- **核心原則 2**：其他角色採用輪流分配，優先分配給最久沒被分配的人
- **運作邏輯**：
  1. 先檢查陳俊亨和郭嘉玲是否都可在該日期服事
  2. **如果都可用** → 強制配對分配到第一堂
  3. **如果有任何一人不可用** → 對所有其他角色採用輪流分配

---

## 2. 自動排班邏輯 (`autoAssign`) - 配對 + 輪流混合版本

### 2.1 聯合排班 (`isJoint = true`)

```
檢查陳俊亨和郭嘉玲是否都可在該日期服事
  ↓
YES → 強制配對分配到第一堂
      service1: { projector: 郭嘉玲, sound: 陳俊亨 }
      service2: { projector: null, sound: null }
  ↓
NO  → 輪流分配（優先分配給最久沒被分配的人）
      1. 選擇投影手（service1，排除第二堂工作人員，優先最久沒被分配的）
      2. 選擇音控手（service1，排除已選的投影手，優先最久沒被分配的）
      service1: { projector: 輪流投影手, sound: 輪流音控手 }
      service2: { projector: null, sound: null }
```

### 2.2 分堂排班 (`isJoint = false`)

```
檢查陳俊亨和郭嘉玲是否都可在該日期服事
  ↓
YES → 強制配對分配到第一堂，第二堂輪流分配
      service1: { projector: 郭嘉玲, sound: 陳俊亨 }
      service2:
        1. 選擇投影手（排除第一堂工作人員和service1已分配的人，優先最久沒被分配的）
        2. 選擇音控手（排除第一堂工作人員和已分配的人，優先最久沒被分配的）
  ↓
NO  → 全部輪流分配（優先分配給最久沒被分配的人）
      service1:
        1. 選擇投影手（排除第二堂工作人員，優先最久沒被分配的）
        2. 選擇音控手（排除第二堂工作人員和service1投影手，優先最久沒被分配的）
      service2:
        1. 選擇投影手（排除第一堂工作人員和service1已分配的人，優先最久沒被分配的）
        2. 選擇音控手（排除第一堂工作人員和已分配的人，優先最久沒被分配的）
```

---

## 3. 人員篩選邏輯 (`getAvailablePerson`)

### 3.1 篩選條件

```javascript
function getAvailablePerson(role, date, excludeIds, service)
```

**必須滿足所有條件：**
1. ✅ **不是失效狀態** (`isInactive === false`)
2. ✅ 具有指定角色（例如：`投影手` 或 `音控手`）
3. ✅ 未被列入該日期的「不可服事日期」
4. ✅ 不在排除名單 (`excludeIds`) 中
5. ✅ **Service 限制**：
   - 如果分配到 `service1`，則排除標記為 `第二堂工作人員` 的人
   - 如果分配到 `service2`，則排除標記為 `第一堂工作人員` 的人

### 3.2 選擇方式
符合條件的人員中，**按最後被分配日期排序**，優先選擇**最久沒被分配的人**
- 從未被分配過 → 優先級最高
- 最後被分配在很久以前 → 優先級次高
- 最近剛被分配 → 優先級最低

---

## 4. 手動選擇邏輯（下拉選單）

### 4.1 Service1 投影手下拉選單

```javascript
people.filter(p => {
  if (!p.roles.includes('投影手')) return false;           // 必須是投影手
  if (p.excludeDates?.includes(date)) return false;       // 不在排除日期
  if (p.roles.includes('第二堂工作人員')) return false;    // 排除第二堂專用人員
  return true;
})
```

### 4.2 Service1 音控手下拉選單

```javascript
people.filter(p => {
  if (!p.roles.includes('音控手')) return false;           // 必須是音控手
  if (p.excludeDates?.includes(date)) return false;       // 不在排除日期
  if (p.roles.includes('第二堂工作人員')) return false;    // 排除第二堂專用人員
  return true;
})
```

### 4.3 Service2 投影手下拉選單

```javascript
people.filter(p => {
  if (!p.roles.includes('投影手')) return false;           // 必須是投影手
  if (p.excludeDates?.includes(date)) return false;       // 不在排除日期
  if (p.roles.includes('第一堂工作人員')) return false;    // 排除第一堂專用人員
  return true;
})
```

### 4.4 Service2 音控手下拉選單

```javascript
people.filter(p => {
  if (!p.roles.includes('音控手')) return false;           // 必須是音控手
  if (p.excludeDates?.includes(date)) return false;       // 不在排除日期
  if (p.roles.includes('第一堂工作人員')) return false;    // 排除第一堂專用人員
  return true;
})
```

---

## 5. 人員角色配置範例

### 郭嘉玲 (投影手)
```
roles: ['第一堂工作人員', '投影手']
excludeDates: []
```
**說明**：可以在第一堂服事，擁有投影手技能

### 陳俊亨 (音控手)
```
roles: ['第一堂工作人員', '音控手']
excludeDates: []
```
**說明**：可以在第一堂服事，擁有音控手技能

### 蔡依錠 (第二堂專用)
```
roles: ['第二堂工作人員', '投影手']
excludeDates: []
```
**說明**：只能在第二堂服事，擁有投影手技能

### 馮小鳳 (通用)
```
roles: ['投影手', '音控手']
excludeDates: ['2025-12-20']  // 這一天無法服事
```
**說明**：兩堂都可服事（無服事堂限制），但12月20日不可

---

## 6. 業務規則總結

| 規則 | 自動排班 | 手動選擇 | 說明 |
|------|---------|---------|------|
| 陳+郭配對 | ✅ 強制優先 | ⚠️ 提示（下拉選單會顯示） | 同一天、同一堂，優先於輪流 |
| 輪流分配 | ✅ 次優先 | ⚠️ 不適用（手動自由選擇） | 當配對不可能時執行 |
| 第一堂限制 | ✅ 檢查 | ✅ 下拉過濾 | 排除第二堂工作人員 |
| 第二堂限制 | ✅ 檢查 | ✅ 下拉過濾 | 排除第一堂工作人員 |
| 排除日期 | ✅ 檢查 | ✅ 下拉過濾 | 不可服事的日期 |
| 不重複分配 | ✅ 檢查 | ⚠️ 允許（需人工控制） | 同一堂不能有兩個角色 |

---

## 7. 常見情況處理

### 情況A：首次自動排班（無前期排班記錄）
**結果**：所有人的「最後被分配日期」都是 1900-01-01，系統將隨機選擇其中一人（因為都是同樣古老的日期）
```
例：第一次排班時，可能分配任何符合條件的人
```

### 情況B：已有多週排班記錄
**結果**：優先  最久沒有被分配過的人
```
假設：
- 上週：林建良和馮小鳳被分配 (2025-12-06)
- 本週：應優先分配 陳俊亨、陳信明、謝欣樺 等未出現過的人
- 即使 林建良 符合條件，也會被排到後面
```

### 情況C：用戶手動選擇 Service1 投影手
**下拉選單顯示**：所有符合條件的投影手（無排序）
```
因為手動選擇，系統不干涉用戶的決定
```

### 情況D：配對優先級演示
**優先級順序**：
1️⃣ **陳俊亨 + 郭嘉玲配對** ⭐⭐⭐⭐⭐ （如果兩人都可用）
2️⃣ **其他人員輪流分配** ⭐⭐⭐ （按最久沒被分配排序）
3️⃣ **手動選擇** ⭐⭐ （用戶自由決定）

---

## 8. 技術實現細節

### 資料結構
```javascript
// 排班記錄
{
  id: "...",
  date: "2025-12-20",
  isJoint: true,  // true=聯合, false=分堂
  assignments: {
    service1: { 
      projector: "personId1",  // 郭嘉玲的ID
      sound: "personId2"        // 陳俊亨的ID
    },
    service2: { 
      projector: null,
      sound: null
    }
  }
}

// 人員記錄
{
  id: "uniqueId",
  name: "郭嘉玲",
  roles: ['第一堂工作人員', '投影手'],
  excludeDates: ['2025-12-25']
}
```

### 篩選流程圖
```
輸入：role, date, excludeIds, service
  ↓
過濾1: 檢查失效狀態 (isInactive === false) 【新增】
  ↓
過濾2: 檢查角色 (role.includes())
  ↓
過濾3: 檢查排除日期 (excludeDates.includes())
  ↓
過濾4: 檢查排除人員 (excludeIds.includes())
  ↓
過濾5: 檢查服事堂次限制
  - service1 → 排除第二堂工作人員
  - service2 → 排除第一堂工作人員
  ↓
【輪流分配邏輯】
計算每人最後被分配日期
  ↓
按最後被分配日期排序（最早的優先）
  ↓
結果：符合條件且最久沒被分配的人
  ↓
選擇：取列表中第一人（最久沒被分配）
```

---

## 9. 人員失效功能（新增 v2.2）

### 9.1 功能說明
- **目的**：處理人員因長期請假、出國出差等原因暫時無法服事的情況
- **操作**：在「維護人員」中勾選「失效（長期請假/出國出差）」即可

### 9.2 失效狀態的影響

| 項目 | 影響 |
|------|------|
| 自動排班 (`autoAssign`) | ❌ 不會被選中分配 |
| 下拉選單 (Dropdowns) | ❌ 不會出現在列表中 |
| 人員列表顯示 | ✅ 會顯示「失效」紅色標籤 |
| 已往配對 | ✅ 不會被取消，只是未來不會分配 |
| 恢復操作 | ✅ 取消勾選即可恢復正常 |

### 9.3 實現細節
- **數據字段**：人員物件新增 `isInactive` 布林值
- **檢查位置**：
  1. `getAvailablePerson()` 的第一個篩選條件
  2. `isPersonAvailableForRole()` 的第一個檢查
  3. 所有下拉選單的 `.filter(p => !p.isInactive)` 檢查

---

## 10. 新增需求或修改指南

如需修改排班邏輯，請檢查以下位置：

| 功能 | 檔案位置 | 函數 |
|------|---------|------|
| 自動排班核心邏輯 | `index.html` | `autoAssign()` |
| 輪流分配機制 | `index.html` | `getLastAssignmentDate()` |
| 人員篩選（含失效檢查） | `index.html` | `getAvailablePerson()` |
| 失效狀態檢查 | `index.html` | `isPersonAvailableForRole()` |
| Service1 投影手下拉 | `index.html` | 行 ~1200 |
| Service1 音控手下拉 | `index.html` | 行 ~1215 |
| Service2 投影手下拉 | `index.html` | 行 ~1260 |
| Service2 音控手下拉 | `index.html` | 行 ~1280 |
| 新增人員表單 | `index.html` | 行 ~830 |
| 編輯人員表單 | `index.html` | 行 ~710 |
| 陳+郭配對檢查 | `index.html` | `autoAssign()` 內部 |

---

**最後更新**：2025-12-13 (v2.2 - 新增失效功能)
````
**版本**：2.1 - 配對優先 + 輪流分配混合版本

### 版本歷史
- v1.0 (2025-12-13 早期)：強制配對陳俊亨和郭嘉玲
- v2.0 (2025-12-13 中期)：純輪流分配，取消配對
- v2.1 (2025-12-13 當前)：**混合版本** - 配對優先，輪流次之
